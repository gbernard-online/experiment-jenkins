node {
    stage('clean') {
        cleanWs()
        sh 'docker container ls --filter=name=alpine --quiet | xargs --no-run-if-empty docker rm --force'
    }
    stage('clone') {
        checkout scm
    }
    stage('build') {
        sh 'docker buildx build --tag=alpine-gcc .'
    }
    stage('test') {
        docker.image('alpine-gcc').withRun('--hostname=alpine.local --name=alpine --username=1000:1000 ' +
        '--volume=/opt/docker/jenkins/data/workspace/experiment-docker:/jenkins --workdir=/jenkins',
        'yes') { c ->
            sh 'docker exec alpine hostname'
            sh 'docker exec alpine id'
            sh 'docker exec alpine pwd'
            sh 'docker exec alpine ls -la'
            sh 'docker exec alpine cat README.md'
        }
    }
}
